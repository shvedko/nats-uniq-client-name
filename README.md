# NATS Unique Client Guard (UNIQUER)

Микросервис на Go для обеспечения **строгой уникальности имен клиентов** в NATS. Он работает как внешний обработчик авторизации, предотвращая подключение нескольких клиентов с одинаковыми именами с помощью распределенной блокировки в Redis.

## Как это работает

1. **Авторизация**: Сервис подписывается на системную тему `$SYS.REQ.USER.AUTH`.
2. **Проверка**: При попытке входа сервис проверяет связку `Username/Password`.
3. **Блокировка**: Если имя клиента (`Client Name`) уже занято другим активным соединением (проверяется через Redis `SETNX`), сервис отклоняет запрос с ошибкой `Unique Client Name Required`.
4. **Освобождение**: При получении системного события `$SYS.ACCOUNT.*.DISCONNECT` сервис удаляет запись из Redis, освобождая имя для новых подключений.

## Стек

* **NATS** (nats.go, nkeys, jwt) — транспорт и протокол авторизации.
* **Redis** (go-redis/v9) — хранилище состояний сессий.
* **JWT/NKeys** — для подписи ответов авторизации.

## Использование

### Конфигурация NATS для внешней авторизации (Auth Callout)

Ниже представлен минимальный пример конфигурации сервера NATS для делегирования аутентификации и авторизации внешнему сервису.

```
accounts {
  # Системный аккаунт для внутреннего управления и работы Callout-сервиса
  SYS {
    users: [ { user: admin, password: password } ]
  }
  # Целевой аккаунт, для которого будет применяться внешняя авторизация
  APP { } 
}

system_account: SYS

# Секция управления доступом через внешний сервис
authorization {
  auth_callout {
    # Публичный ключ (NKey) издателя, подписывающего токены авторизации
    issuer: AA3MCC7NAP5TM6TJFOYHSWAKLBNUFM3MTCRV6H6XD2ZNRRZ2KFTUUV6Z
    
    # Список пользователей (в контексте SYS), имеющих право обрабатывать запросы авторизации
    auth_users: [ admin ]
    
    # Аккаунт, в котором работает сервис авторизации
    account: SYS
  }
}
```

### Управление ключами NKey

Для генерации пары ключей используется утилита nk. Команда для создания ключа типа Account:
```bash
nk -gen account -pubout
```

При работе с результатами генерации важно различать компоненты пары:

* **Public Key (начинается на A...)** — открытый ключ, который вносится в параметр `issuer` конфигурационного файла NATS.
* **Seed/Private Key (начинается на S...)** — закрытый ключ, который используется внешним сервисом авторизации для подписи ответных JWT. **Должен храниться в секрете**.

### Настройка

Для работы сервиса необходимо передать конфигурацию NATS и Redis:
```go
options1 := nats.GetDefaultOptions()
options1.Url = "nats://localhost:4222"

options2 := redis.Options{
    Addr: "localhost:6379",
}

service := uniq.New(options1, options2)
```

### Запуск

Сервису нужен seed (NKey) для подписи JWT-ответов и карта допустимых аккаунтов:
```go
accounts := map[string]map[string]string{
    "MY_ACCOUNT": {
        "user1": "password123",
    },
}

ctx := context.Background()
err := service.Start(ctx, "SUA...", accounts)
```

## Ключевые особенности
* **Race Condition Protection**: Использует атомарные операции Redis для исключения дубликатов в высоконагруженных средах.
* **Queue Groups**: Подписки используют очередь `UNIQUER`, что позволяет горизонтально масштабировать сам сервис авторизации.
* **Автоматическая очистка**: Следит за событиями отключения клиентов для своевременного освобождения имен.
